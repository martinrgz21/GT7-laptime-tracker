<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GT7 Lap Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colors: Oceanic Blue and Grays */
            --primary-color: #376893; /* Oceanic Blue */
            --primary-light-color: #4a7ea4; /* Lighter shade of blue for hover */
            --background-light: #F8F9FA; /* Very light gray for main background */
            --background-medium: #E9ECEF; /* Medium gray for filter background and even rows */
            --text-color: #343A40; /* Dark gray for general text */
            --heading-color: #2F5374; /* Slightly darker blue for headings */
            --border-color: #CED4DA; /* Soft gray for borders */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Standard shadow */
            --fastest-lap-bg: #D4EDDA; /* Green for fastest lap */
            --fastest-lap-text: #155724;
            --error-color: #dc3545; /* Red for error messages */

            /* New Fonts */
            --main-font: 'Roboto', sans-serif;
            --display-font: 'Montserrat', sans-serif; 
        }

        body {
            font-family: var(--main-font);
            margin: 0;
            padding: 20px;
            background-color: var(--background-light);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1, h2 {
            font-family: var(--display-font); /* Montserrat for headings */
            color: var(--heading-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 30px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--text-color);
            background-color: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: var(--main-font); /* Roboto for inputs */
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group input[type="file"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(55, 104, 147, 0.25);
            outline: none;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-right: 15px;
            font-family: var(--display-font); /* Montserrat for buttons */
        }

        button:hover {
            background-color: var(--primary-light-color);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: var(--background-medium);
            border-radius: 10px;
        }

        /* Container for the table that allows horizontal scrolling */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border-radius: 8px;
            overflow: hidden; /* Important for border-radius to apply to content */
            font-family: var(--main-font); /* Roboto for the table */
            min-width: 700px; /* Ensures the table has a minimum width to enable scrolling on small screens if necessary */
        }

        table th, table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--background-medium);
            white-space: nowrap; /* Prevents text from wrapping to multiple lines */
        }

        table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1;
            font-family: var(--display-font); /* Montserrat for table headers */
        }

        table tbody tr:nth-child(even) {
            background-color: var(--background-light);
        }

        table tbody tr:hover {
            background-color: var(--background-medium);
            transition: background-color 0.2s ease;
        }

        .fastest-lap {
            background-color: var(--fastest-lap-bg) !important;
            color: var(--fastest-lap-text);
            font-weight: bold;
        }
        
        .error-message {
            color: var(--error-color);
            margin-top: 5px;
            font-size: 0.875em;
            font-weight: 500;
        }

        .backup-section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
            text-align: center;
        }

        .backup-section p {
            margin-bottom: 15px;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .container {
                padding: 20px;
            }
            .filters {
                grid-template-columns: 1fr;
            }
            button {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
            table th, table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GT7 Lap Tracker</h1>

        <h2>Register New Lap</h2>
        <div class="form-group">
            <label for="nombrePiloto">Your Driver Name:</label>
            <input type="text" id="nombrePiloto" placeholder="Ex: MyGT7Nick" required>
        </div>
        <div class="form-group">
            <label for="circuito">Track:</label>
            <select id="circuito" onchange="populateLayoutSelect()" required>
                <option value="">Select a track</option>
            </select>
        </div>
        <div class="form-group">
            <label for="trazado">Layout:</label>
            <select id="trazado" required>
                <option value="">Select a layout</option>
            </select>
        </div>
        <div class="form-group">
            <label for="marcaCoche">Car Make:</label>
            <input type="text" id="marcaCoche" placeholder="Ex: Porsche" required>
        </div>
        <div class="form-group">
            <label for="modeloCoche">Car Model:</label>
            <input type="text" id="modeloCoche" placeholder="Ex: 911 GT3 RS" required>
        </div>
        <div class="form-group">
            <label for="prCoche">PR (Performance Rating):</label>
            <input type="number" id="prCoche" min="0" placeholder="Ex: 400" required>
            <div class="error-message" id="prCocheError"></div>
        </div>
        <div class="form-group">
            <label for="tiempoVuelta">Lap Time (mm:ss:SSS):</label>
            <input type="text" id="tiempoVuelta" pattern="[0-5]?\d:[0-5]?\d:\d{3}" placeholder="Ex: 01:30:123" required>
            <div class="error-message" id="tiempoVueltaError"></div>
        </div>
        <button onclick="registrarVuelta()">Register Lap</button>
    </div>

    <div class="container">
        <h2>Registered Laps</h2>

        <div class="filters">
            <div class="form-group">
                <label for="filterNombrePiloto">Filter by Driver:</label>
                <select id="filterNombrePiloto" onchange="aplicarFiltros()">
                    <option value="">All Drivers</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filterCircuito">Filter by Track:</label>
                <input type="text" id="filterCircuito" onkeyup="aplicarFiltros()" placeholder="All">
            </div>
            <div class="form-group">
                <label for="filterMarcaCoche">Filter by Make:</label>
                <input type="text" id="filterMarcaCoche" onkeyup="aplicarFiltros()" placeholder="All">
            </div>
            <div class="form-group">
                <label for="filterModeloCoche">Filter by Model:</label>
                <input type="text" id="filterModeloCoche" onkeyup="aplicarFiltros()" placeholder="All">
            </div>
            <div class="form-group">
                <label for="filterPrCoche">Filter by PR:</label>
                <input type="number" id="filterPrCoche" onkeyup="aplicarFiltros()" placeholder="All">
            </div>
        </div>

        <div class="table-responsive">
            <table id="tablaVueltas">
                <thead>
                    <tr>
                        <th>Driver</th>
                        <th>Track</th>
                        <th>Layout</th>
                        <th>Make</th>
                        <th>Model</th>
                        <th>PR</th>
                        <th>Time</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="backup-section">
            <h2>Data Management (Backup/Restore)</h2>
            <p>You can download your lap data as a backup file or upload a backup file to restore your data.</p>
            <button onclick="descargarDatos()">Download Backup</button>
            <input type="file" id="subirBackupInput" accept=".json" style="display: none;" onchange="subirDatos(event)">
            <button onclick="document.getElementById('subirBackupInput').click()">Upload Backup</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'gt7Laps'; // Changed storage key for clarity
        let vueltas = [];

        const circuitosGT7 = {
            "Asia-Pacific": {
                "Autopolis International Racing Course": [],
                "Broad Bean Raceway": [],
                "Fuji International Speedway": [],
                "High Speed Ring": [],
                "Kyoto Driving Park": ["Miyabi", "Yamagiwa", "Yamagiwa + Miyabi"],
                "Mount Panorama": [],
                "Suzuka Circuit": ["Suzuka Circuit East"],
                "Tokyo Expressway": ["Central Inner Loop", "Central Outer Loop", "East Inner Loop", "East Outer Loop", "South Inner Loop", "South Outer Loop"],
                "Tsukuba Circuit": []
            },
            "America": { // Translated region name
                "Autódromo José Carlos Pace": [],
                "Blue Moon Bay Speedway": [],
                "Colorado Springs": [],
                "Daytona International Speedway": ["Daytona Superspeedway", "Daytona Road Course"],
                "Fisherman’s Ranch": [],
                "Northern Isle Speedway": [],
                "Trial Mountain Circuit": [],
                "Special Stage Route X": [],
                "WeatherTech Raceway Laguna Seca": [],
                "Willow Springs International Raceway": ["Big Willow"]
            },
            "Europe": { // Translated region name
                "Alsace – Village": [],
                "Autodrome Lago Maggiore": [],
                "Autodromo Nazionale Monza": [],
                "Brands Hatch": [],
                "Circuit de Barcelona-Catalunya": [],
                "Circuit de la Sarthe": [],
                "Circuit de Sainte-Croix": ["A", "B", "C"],
                "Circuit de Spa-Francorchamps": [],
                "Deep Forest Raceway": [],
                "Dragon Trail": ["Gardens", "Seaside"],
                "Goodwood Motor Circuit": [],
                "Nürburgring": ["24h", "Nordschleife"],
                "Red Bull Ring": [],
                "Sardegna": ["Road Track – A", "Road Track – B", "Road Track – C"],
                "Windmills": []
            }
        };

        // Function to convert time from mm:ss:SSS to milliseconds
        function timeToMilliseconds(timeStr) {
            const parts = timeStr.split(':');
            if (parts.length !== 3) return NaN;

            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            const milliseconds = parseInt(parts[2], 10);

            if (isNaN(minutes) || isNaN(seconds) || isNaN(milliseconds)) return NaN;

            return (minutes * 60 * 1000) + (seconds * 1000) + milliseconds;
        }

        // Function to convert milliseconds to mm:ss:SSS
        function millisecondsToTime(ms) {
            if (isNaN(ms)) return 'N/A';

            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = ms % 1000;

            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(milliseconds).padStart(3, '0')}`;
        }

        // Load laps and populate filters on startup
        document.addEventListener('DOMContentLoaded', () => {
            const storedLaps = localStorage.getItem(STORAGE_KEY);
            if (storedLaps) {
                vueltas = JSON.parse(storedLaps);
            }
            populateTrackSelect();
            populateDriverFilter();
            displayLaps();
        });

        // Function to populate the Track dropdown
        function populateTrackSelect() {
            const trackSelect = document.getElementById('circuito');
            trackSelect.innerHTML = '<option value="">Select a track</option>';

            for (const region in circuitosGT7) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = region;
                for (const trackName in circuitosGT7[region]) {
                    const option = document.createElement('option');
                    option.value = trackName;
                    option.textContent = trackName;
                    optgroup.appendChild(option);
                }
                trackSelect.appendChild(optgroup);
            }
            populateLayoutSelect(); // Call this to ensure layout is updated even on initial load if a track was pre-selected (though not in this use case)
        }

        // Function to populate the Layout dropdown based on the selected track
        function populateLayoutSelect() {
            const trackSelect = document.getElementById('circuito');
            const layoutSelect = document.getElementById('trazado');
            const selectedTrack = trackSelect.value;

            layoutSelect.innerHTML = '<option value="">Select a layout</option>';

            if (selectedTrack) {
                let layouts = [];
                for (const region in circuitosGT7) {
                    if (circuitosGT7[region][selectedTrack]) {
                        layouts = circuitosGT7[region][selectedTrack];
                        break;
                    }
                }

                if (layouts.length > 0) {
                    layouts.forEach(layout => {
                        const option = document.createElement('option');
                        option.value = layout;
                        option.textContent = layout;
                        layoutSelect.appendChild(option);
                    });
                } else {
                    // If no specific layouts, the track is its own layout
                    const option = document.createElement('option');
                    option.value = selectedTrack;
                    option.textContent = selectedTrack;
                    layoutSelect.appendChild(option);
                    layoutSelect.value = selectedTrack; // Automatically select if only one option
                }
            }
        }

        function validateTime(time) {
            const regex = /^\d{2}:\d{2}:\d{3}$/;
            return regex.test(time);
        }

        function registrarVuelta() { // Renamed to registerLap() in HTML call, but keeping for consistency in JS for now
            const driverName = document.getElementById('nombrePiloto').value.trim();
            const track = document.getElementById('circuito').value.trim();
            const layout = document.getElementById('trazado').value.trim();
            const carMake = document.getElementById('marcaCoche').value.trim();
            const carModel = document.getElementById('modeloCoche').value.trim();
            const prCarInput = document.getElementById('prCoche');
            const prCar = prCarInput.value.trim();
            const lapTime = document.getElementById('tiempoVuelta').value.trim();
            const lapTimeError = document.getElementById('tiempoVueltaError');
            const prCarError = document.getElementById('prCocheError');

            lapTimeError.textContent = '';
            prCarError.textContent = '';

            if (!driverName || !track || !layout || !carMake || !carModel || !prCar || !lapTime) {
                alert('Please fill in all fields.');
                return;
            }

            if (!validateTime(lapTime)) {
                lapTimeError.textContent = 'Incorrect time format. Use mm:ss:SSS (e.g., 01:30:123).';
                return;
            }
            
            // Validate that PR is a positive number
            if (isNaN(parseInt(prCar, 10)) || parseInt(prCar, 10) < 0) {
                prCarError.textContent = 'PR must be a positive number.';
                return;
            }

            const newLap = {
                driverName: driverName,
                track: track,
                layout: layout,
                carMake: carMake,
                carModel: carModel,
                prCar: parseInt(prCar, 10), // Save as number
                lapTime: lapTime,
                timeMilliseconds: timeToMilliseconds(lapTime)
            };

            vueltas.push(newLap);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(vueltas));
            clearForm();
            populateDriverFilter();
            displayLaps();
        }

        function clearForm() {
            document.getElementById('circuito').value = '';
            document.getElementById('trazado').value = '';
            document.getElementById('marcaCoche').value = '';
            document.getElementById('modeloCoche').value = '';
            document.getElementById('prCoche').value = '';
            document.getElementById('tiempoVuelta').value = '';
            populateLayoutSelect();
        }

        function populateDriverFilter() {
            const filterDriverSelect = document.getElementById('filterNombrePiloto');
            const currentSelection = filterDriverSelect.value;
            filterDriverSelect.innerHTML = '<option value="">All Drivers</option>';

            const drivers = [...new Set(vueltas.map(lap => lap.driverName))];

            drivers.sort().forEach(driver => {
                const option = document.createElement('option');
                option.value = driver;
                option.textContent = driver;
                filterDriverSelect.appendChild(option);
            });
            if ([...drivers].includes(currentSelection)) {
                filterDriverSelect.value = currentSelection;
            }
        }

        function aplicarFiltros() { // Renamed to applyFilters() in HTML call, but keeping for consistency in JS for now
            displayLaps();
        }

        function displayLaps() {
            const tbody = document.querySelector('#tablaVueltas tbody');
            tbody.innerHTML = '';

            let filteredLaps = [...vueltas];

            const filterDriverName = document.getElementById('filterNombrePiloto').value.trim();
            const filterTrack = document.getElementById('filterCircuito').value.toLowerCase().trim();
            const filterCarMake = document.getElementById('filterMarcaCoche').value.toLowerCase().trim();
            const filterCarModel = document.getElementById('filterModeloCoche').value.toLowerCase().trim();
            const filterPrCar = document.getElementById('filterPrCoche').value.trim();

            if (filterDriverName) {
                filteredLaps = filteredLaps.filter(lap =>
                    lap.driverName === filterDriverName
                );
            }
            if (filterTrack) {
                filteredLaps = filteredLaps.filter(lap =>
                    lap.track.toLowerCase().includes(filterTrack)
                );
            }
            if (filterCarMake) {
                filteredLaps = filteredLaps.filter(lap =>
                    lap.carMake.toLowerCase().includes(filterCarMake)
                );
            }
            if (filterCarModel) {
                filteredLaps = filteredLaps.filter(lap =>
                    lap.carModel.toLowerCase().includes(filterCarModel)
                );
            }
            if (filterPrCar) { // Filter by PR as a number
                const prNum = parseInt(filterPrCar, 10);
                if (!isNaN(prNum)) {
                    filteredLaps = filteredLaps.filter(lap =>
                        lap.prCar === prNum
                    );
                }
            }

            let fastestLapMs = Infinity;
            if (filteredLaps.length > 0) {
                fastestLapMs = Math.min(...filteredLaps.map(v => v.timeMilliseconds));
            }

            filteredLaps.forEach(lap => {
                const row = tbody.insertRow();
                row.insertCell().textContent = lap.driverName;
                row.insertCell().textContent = lap.track;
                row.insertCell().textContent = lap.layout;
                row.insertCell().textContent = lap.carMake;
                row.insertCell().textContent = lap.carModel;
                row.insertCell().textContent = lap.prCar; // The value is already a number
                row.insertCell().textContent = lap.lapTime;

                const differenceCell = row.insertCell();
                if (lap.timeMilliseconds === fastestLapMs) {
                    differenceCell.textContent = 'Fastest Lap';
                    row.classList.add('fastest-lap');
                } else {
                    const differenceMs = lap.timeMilliseconds - fastestLapMs;
                    differenceCell.textContent = `+${millisecondsToTime(differenceMs)}`;
                }
            });
        }

        // --- Backup/Restore Functions ---

        function descargarDatos() { // Renamed to downloadData() in HTML call, but keeping for consistency in JS for now
            const dataStr = JSON.stringify(vueltas, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gt7_laps_backup_${new Date().toISOString().slice(0,10)}.json`; // Updated filename
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Backup downloaded successfully!');
        }

        function subirDatos(event) { // Renamed to uploadData() in HTML call, but keeping for consistency in JS for now
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedLaps = JSON.parse(e.target.result);

                    // More robust validation when loading data
                    if (Array.isArray(loadedLaps) && loadedLaps.every(v => 
                        v.driverName && 
                        v.lapTime && 
                        (v.timeMilliseconds !== undefined || timeToMilliseconds(v.lapTime) !== NaN) &&
                        (v.prCar !== undefined && !isNaN(parseInt(v.prCar, 10))) 
                    )) {
                        const confirmation = confirm('Are you sure you want to replace your current laps with the backup file? This action cannot be undone.');
                        if (confirmation) {
                            vueltas = loadedLaps.map(lap => ({
                                ...lap,
                                // Ensure timeMilliseconds and prCar are saved as numbers
                                timeMilliseconds: lap.timeMilliseconds !== undefined ? lap.timeMilliseconds : timeToMilliseconds(lap.lapTime),
                                prCar: parseInt(lap.prCar, 10) // Ensure PR is a number
                            }));
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(vueltas));
                            populateDriverFilter();
                            displayLaps();
                            alert('Data restored successfully!');
                        }
                    } else {
                        alert('The file does not appear to be a valid GT7 laps backup. Please ensure you upload the correct .json file and that it contains the expected fields (driver, time, prCar).');
                    }
                } catch (error) {
                    console.error("Error parsing JSON file:", error);
                    alert('Error reading the file. Please ensure it is a valid .json file.');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
